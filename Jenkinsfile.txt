pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'my-application'
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_REGISTRY = '131924/kubernetes.com'
        K8S_NAMESPACE = 'my-application-ns'
        KUBECONFIG = credentials('kubeconfig')
    }
    
    stages {
        stage('Checkout source') {
    steps {
        git url: 'https://github.com/Shri19-web/Kubernetes.git',
            credentialsId: 'github-creds',
            branch: "${env.BRANCH_NAME ?: 'main'}"
    }
}

        stage('Install Dependencies') {
            steps {
                script {
                    sh 'npm ci'
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                script {
                    sh 'npm test'
                }
            }
            post {
                always {
                    junit 'test-results.xml' testResultsPattern: 'test-results.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    def image = docker.build("${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}")
                    docker.withRegistry("https://${131924/kubernetes.com}", 'docker-registry-creds') {
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                script {
                    sh "docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}"
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    sh """
                        sed -i 's|IMAGE_TAG|${DOCKER_TAG}|g' k8s-manifests/deployment.yaml
                        kubectl apply -f k8s-manifests/ -n staging
                        kubectl rollout status deployment/${DOCKER_IMAGE} -n staging
                    """
                }
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                script {
                    input message: 'Deploy to production?', ok: 'Deploy'
                    sh """
                        sed -i 's|IMAGE_TAG|${DOCKER_TAG}|g' k8s-manifests/deployment.yaml
                        kubectl apply -f k8s-manifests/ -n ${K8S_NAMESPACE}
                        kubectl rollout status deployment/${DOCKER_IMAGE} -n ${K8S_NAMESPACE}
                    """
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
            emailext (
                subject: "Build Failed: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "Build failed. Check console output at ${env.BUILD_URL}",
                to: "${env.CHANGE_vidyacb19@gmail.com}"
            )
        }
    }
}
